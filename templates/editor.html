<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <style>
    /* Custom styles for bespoke elements and interactions */
    body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: all 0.3s ease-in-out;
    }
    /* Accordion custom styling */
    details > summary {
        list-style: none;
    }
    details > summary::-webkit-details-marker {
        display: none;
    }
    details > summary::after {
        content: '＋';
        float: right;
        font-size: 1.2rem;
        line-height: 1;
        color: #999;
        transition: transform 0.2s ease-in-out;
    }
    details[open] > summary::after {
        transform: rotate(45deg);
    }
    /* Custom file input */
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        cursor: pointer;
    }
    .file-input-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
    }
    /* Item row editing focus effect */
    #items_table tbody tr.is-editing td.is-focused {
      background-color: #f1f1f1;
      transition: all 0.3s ease-in-out;
      transform: scale(2);  /* makes the cell appear wider */
      transform-origin: left center;
      z-index: 20000;
      position: relative;
    }
    #items_table tbody tr.is-editing td.is-focused {
        display: table-cell;
        width: 100%;
    }
    #items_table tbody tr.is-editing td.actions-cell {
        display: table-cell;
    }
    /* Bespoke input field base style */
    .input-field {
        width: 100%;
        border: 0;
        border-bottom: 1px solid #d4d4d4; /* neutral-300 */
        background-color: transparent;
        padding: 8px 4px;
        transition: border-color 0.2s ease-in-out;
    }
    .input-field:focus {
        outline: none;
        border-bottom-color: #000000; /* black */
        box-shadow: none;
        
    }
  </style>
</head>

<body class="bg-neutral-100 text-neutral-800 font-inter">
  <div class="flex flex-col lg:flex-row h-screen">
    <div class="w-full lg:w-[620px] bg-white border-r border-neutral-200 flex flex-col">
      <header class="p-6 border-b border-neutral-200 flex items-center justify-between shrink-0">
        <h1 class="text-xl font-bold tracking-tight flex items-center gap-2">Invoice Builder</h1>
        <span id="save-status" class="text-xs text-neutral-500 font-medium">Saved</span>
      </header>

      <div id="editor-panel" class="p-6 overflow-y-auto space-y-6">
        <details open>
            <summary class="text-lg font-semibold cursor-pointer pb-4 border-b">Brand Details</summary>
            <div class="pt-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-neutral-500">Brand Name</label>
                        <input id="brand_name" class="input-field" type="text" />
                    </div>
                    <div>
                        <label class="text-xs text-neutral-500">RC Number</label>
                        <input id="rc_number" class="input-field" type="text" />
                    </div>
                </div>
                <div>
                    <label class="text-xs text-neutral-500">Address</label>
                    <textarea id="address" class="input-field min-h-[60px]"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-neutral-500">Phone</label>
                        <input id="phone" class="input-field" type="text" />
                    </div>
                    <div>
                        <label class="text-xs text-neutral-500">Email</label>
                        <input id="email" class="input-field" type="email" />
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="text-xs text-neutral-500">Brand Color</label>
                        <input id="brand_color" type="color" class="w-full h-10 border-0 bg-neutral-100 rounded-md" value="#000000" />
                    </div>
                    <div>
                        <label class="text-xs text-neutral-500">Accent Color</label>
                        <input id="accent_color" type="color" class="w-full h-10 border-0 bg-neutral-100 rounded-md" value="#808080" />
                    </div>
                    <div class="file-input-wrapper w-full h-10 bg-black text-white text-sm font-semibold rounded-md flex items-center justify-center">
                        <span>Upload Logo</span>
                        <input id="logo" type="file" accept="image/*" />
                    </div>
                </div>
            </div>
        </details>

        <details>
            <summary class="text-lg font-semibold cursor-pointer py-4 border-b">Client Details</summary>
            <div class="pt-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-neutral-500">Invoice Number</label>
                        <input id="invoice_number" class="input-field" />
                    </div>
                    <div>
                        <label class="text-xs text-neutral-500">Date</label>
                        <input id="date" class="input-field" type="date" />
                    </div>
                </div>
                <div>
                    <label class="text-xs text-neutral-500">Client Name</label>
                    <input id="client_name" class="input-field" />
                </div>
                <div>
                    <label class="text-xs text-neutral-500">Invoice Title</label>
                    <input id="invoice_title" class="input-field" />
                </div>
            </div>
        </details>

        <details>
            <summary class="text-lg font-semibold cursor-pointer py-4 border-b">Payment Details</summary>
            <div class="pt-4 space-y-4">
                <div>
                    <label class="text-xs text-neutral-500">Payee Name</label>
                    <input id="payee_name" class="input-field" placeholder="e.g. Zatras Global Services Ltd" />
                </div>
                <div>
                    <label class="text-xs text-neutral-500">Account Number</label>
                    <input id="account_number" class="input-field" placeholder="e.g. 0123456789" />
                </div>
                <div>
                    <label class="text-xs text-neutral-500">Bank Name</label>
                    <input id="bank_name" class="input-field" placeholder="e.g. Access Bank" />
                </div>
            </div>
        </details>

        <details >
            <summary class="text-lg font-semibold cursor-pointer py-4 border-b">Invoice Items Details</summary>
        <section>
            
            <table id="items_table" class="w-full text-sm">
                <thead>
                    <tr class="text-neutral-500 text-xs border-b">
                        <th class="text-left font-medium py-2 w-full">Description</th>
                        <th class="font-medium px-2">Qty</th>
                        <th class="font-medium px-2">Price</th>
                        <th class="text-right font-medium py-2">Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="addRow()" class="mt-4 w-full bg-neutral-100 hover:bg-neutral-200 py-2.5 rounded-md text-sm font-semibold transition-colors">Add Item</button>
        </section>
        </details>
        <section class="bg-neutral-50 p-4 rounded-lg">
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-neutral-600">Subtotal</span>
                    <span id="subtotal" class="font-medium">₦0.00</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-neutral-600">VAT (7.5%)</span>
                    <span id="vat_amount" class="font-medium">₦0.00</span>
                </div>
                 <div class="flex justify-between items-center text-xl font-bold border-t border-neutral-200 pt-3 mt-3">
                    <span>Total Due</span>
                    <span id="total_due">₦0.00</span>
                </div>
            </div>
              <button onclick="downloadPDF()" class="mt-6 w-full bg-black hover:bg-neutral-800 text-white py-3 rounded-md font-semibold transition-colors">Download PDF</button>
        </section>
      </div>
    </div>

    <div class="flex-1 bg-neutral-100 flex justify-center items-start p-4 lg:p-8">
      <iframe id="preview" class="w-full max-w-4xl h-full bg-white rounded-xl shadow-lg border border-neutral-200"></iframe>
    </div>
  </div>
  
  <script>
    const STORAGE_KEY = "invoice_data_v4";
    const previewFrame = document.getElementById("preview");
    const saveStatus = document.getElementById("save-status");
    document.getElementById("date").valueAsDate = new Date();

    const sampleData = {
        brand_name: "Innovate Solutions Inc.",
        rc_number: "RC 1234567",
        address: "123 Innovation Drive, Business District, Abuja, Nigeria",
        phone: "+234 801 234 5678",
        email: "contact@innovatesolutions.com",
        invoice_number: "INV-001",
        client_name: "Global Tech Ltd.",
        invoice_title: "Q3 Web Development Services",
        payee_name: "Innovate Solutions Inc.",
        account_number: "0123456789",
        bank_name: "Prestige Bank Plc",
        items: [
            { description: "Website Design & Development", quantity: 1, unit_price: 750000, total: 750000 },
            { description: "Content Management System (CMS) Setup", quantity: 1, unit_price: 250000, total: 250000 },
            { description: "Monthly Website Maintenance (Oct)", quantity: 1, unit_price: 50000, total: 50000 },
        ]
    };

    function populateWithSampleData() {
        Object.entries(sampleData).forEach(([key, val]) => {
            const el = document.getElementById(key);
            if (el && key !== 'items') {
                el.value = val;
            }
        });
        if (sampleData.items) {
            restoreItems(sampleData.items);
        }
    }

    function loadSavedData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) {
        populateWithSampleData();
        return false; // Indicates no saved data was found
      }
      const data = JSON.parse(saved);
      Object.entries(data).forEach(([key, val]) => {
        const el = document.getElementById(key);
        if (el) el.value = val;
      });
      if (data.items) restoreItems(data.items);
      return true; // Indicates saved data was found and loaded
    }


    
    function createRowHTML(item = {}) {
        const desc = item.description || "";
        const qty = item.quantity || 1;
        const price = item.unit_price || 0;
        const total = (item.total || 0).toFixed(2);
        
        return `
            <td class="pt-2 w-full"><input type="text" value="${desc}" placeholder="Item description" class="input-field" /></td>
            <td class="pt-2"><input type="number" value="${qty}" class="input-field w-16 text-center" /></td>
            <td class="pt-2"><input type="number" value="${price}" class="input-field w-24 text-center" /></td>
            <td class="total text-right pt-2 pr-2 font-medium">${total}</td>
            <td class="actions-cell text-center pt-2"><button class="text-neutral-400 hover:text-red-500 text-lg" onclick="removeRow(this)">✕</button></td>
        `;
    }

    function restoreItems(items) {
      const tbody = document.querySelector("#items_table tbody");
      tbody.innerHTML = "";
      items.forEach((item) => {
        const row = tbody.insertRow();
        row.innerHTML = createRowHTML(item);
      });
    }

    let saveTimer;
    function saveToLocal() {
      clearTimeout(saveTimer);
      saveStatus.textContent = "Saving...";
      saveTimer = setTimeout(() => {
        const data = collectData();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        saveStatus.textContent = "Saved";
      }, 500);
    }

    function addRow() {
      const tbody = document.querySelector("#items_table tbody");
      const row = tbody.insertRow();
      row.innerHTML = createRowHTML();
      updatePreview();
    }

    function removeRow(btn) {
      btn.closest("tr").remove();
      updatePreview();
    }

    function formatCurrency(num) {
      return "₦" + num.toLocaleString("en-NG", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function calculateTotals(items) {
      const subtotal = items.reduce((s, i) => s + i.total, 0);
      const vat = subtotal * 0.075;
      const total = subtotal + vat;
      document.getElementById("subtotal").textContent = formatCurrency(subtotal);
      document.getElementById("vat_amount").textContent = formatCurrency(vat);
      document.getElementById("total_due").textContent = formatCurrency(total);
      return { subtotal, vat_amount: vat, total_due: total };
    }

    function collectData(context = 'pdf') { // Default context is 'pdf'
      const inputs = Array.from(document.querySelectorAll("#editor-panel input, #editor-panel textarea"));
      const data = {};
      inputs.forEach((el) => {
        if (el.type !== "file" && el.id) data[el.id] = el.value;
      });

      const items = Array.from(document.querySelectorAll("#items_table tbody tr")).map((tr) => {
        const [desc, qty, price] = tr.querySelectorAll("input");
        const total = parseFloat(qty.value || 0) * parseFloat(price.value || 0);
        tr.querySelector(".total").textContent = total.toFixed(2);
        return {
          description: desc.value,
          quantity: parseFloat(qty.value || 0),
          unit_price: parseFloat(price.value || 0),
          total,
        };
      });

      const totals = calculateTotals(items);
      
      // *** MODIFICATION START ***
      // Determine which logo URL to use based on the context (preview or pdf)
      const logoKey = context === 'preview' ? 'logo_url' : 'pdf_logo_url';
      const logoUrl = localStorage.getItem(logoKey);
      // *** MODIFICATION END ***

      // The original logic used the same URL for both brand logo and watermark.
      // We will maintain that structure, but use the contextually-correct URL.
      return { ...data, items, ...totals, brand_logo_url: logoUrl, watermark_url: logoUrl };
    }


    let previewTimer;
    function updatePreview() {
      saveToLocal();
      clearTimeout(previewTimer);
      previewTimer = setTimeout(async () => {
        // *** MODIFICATION *** Pass 'preview' context
        const data = collectData('preview'); 
        try {
            const res = await fetch("/render_invoice", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });
            if (!res.ok) throw new Error('Preview generation failed');
            const { html } = await res.json();
            previewFrame.srcdoc = html;
        } catch (error) {
            console.warn("Could not render preview (backend not running?). Using fallback message.");
            previewFrame.srcdoc = `<div style="padding:2rem; font-family:sans-serif; text-align:center;"><h2>Preview Unavailable</h2><p>Could not connect to the backend server to render the invoice preview.</p></div>`;
        }
      }, 500);
    }
    
    document.addEventListener("DOMContentLoaded", () => {
        // Consolidated event listener for all inputs using delegation
        document.getElementById('editor-panel').addEventListener('input', (e) => {
            if (e.target.matches('input, textarea')) {
                updatePreview();
            }
        });
        
        loadSavedData();
        updatePreview();
        if(!document.querySelector("#items_table tbody tr")) {
            addRow();
        }
    });

    async function downloadPDF() {
        // *** MODIFICATION *** Pass 'pdf' context for clarity, though it's the default
        const data = collectData('pdf'); 
        const button = document.querySelector("button[onclick='downloadPDF()']");
        const originalText = button.textContent;
        button.textContent = 'Generating...';
        button.disabled = true;

        try {
            const res = await fetch("/generate_pdf", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            if (!res.ok) throw new Error('PDF generation failed. Check your server logs.');
            
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `invoice_${data.invoice_number || "draft"}.pdf`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

        } catch (error) {
            alert(error.message);
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    const logoInput = document.getElementById("logo");
    logoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Create a new FileReader instance
    const reader = new FileReader();

    // Define what happens when the file is successfully read
    reader.onload = () => {
        // The result is the Base64 encoded string
        const base64String = reader.result;

        // Store the Base64 string in localStorage for both web and PDF use
        localStorage.setItem("logo_url", base64String);
        localStorage.setItem("pdf_logo_url", base64String);

        // Update the preview with the new logo
        updatePreview();
    };

    // Define what happens if there's an error reading the file
    reader.onerror = (error) => {
        console.error("Error: ", error);
        alert("Error converting logo.");
    };

    // Start the process of reading the file as a Data URL (Base64)
    reader.readAsDataURL(file);
});
    // Event delegation for item row focus effect
    const itemsTbody = document.querySelector("#items_table tbody");

    itemsTbody.addEventListener('focusin', (e) => {
        if (e.target.matches('input')) {
            const tr = e.target.closest('tr');
            // First, remove 'is-focused' from any other cell in the same row
            tr.querySelectorAll('.is-focused').forEach(cell => cell.classList.remove('is-focused'));
            
            const td = e.target.closest('td');
            tr.classList.add('is-editing');
            td.classList.add('is-focused');
        }
    });

    itemsTbody.addEventListener('focusout', (e) => {
        if (e.target.matches('input')) {
            const tr = e.target.closest('tr');
            // Use a small delay to allow focus to shift between inputs in the same row
            setTimeout(() => {
                // If the new active element is NOT inside this row, collapse the row.
                if (!tr.contains(document.activeElement)) {
                    tr.classList.remove('is-editing');
                    // And remove the focus class from all cells within it
                    tr.querySelectorAll('.is-focused').forEach(cell => cell.classList.remove('is-focused'));
                }
            }, 0);
        }
    });
  </script>
</body>
</html>